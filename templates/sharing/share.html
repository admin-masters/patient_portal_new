{% extends "base.html" %}
{% block title %}{{ doctor.clinic.display_name }} — Share Patient Education{% endblock %}
{% block header_title %}{{ doctor.clinic.display_name }}{% endblock %}

{% block head %}
<style>
  .profile-row { display: flex; align-items: center; gap: 12px; }
  .avatar { width: 72px; height: 72px; border-radius: 18px; border: 1px solid #e6e6e6; background: #111827; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: 800; position: relative; overflow: hidden; }
  .avatar-img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
  .kv { margin: 6px 0; }
  .kv b { display: inline-block; min-width: 120px; }

  @media (min-width: 760px) { .row.three { grid-template-columns: 1fr 1fr 1fr; } }

  select, input[type="text"], input[type="tel"] {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 10px;
    background: #fff;
    color: #111827;
    box-sizing: border-box;
  }
  select option { color: #111827; background: #fff; }

  .btn, button {
    display: inline-block;
    border-radius: 10px;
    padding: 10px 12px;
    font-weight: 600;
    text-align: center;
    cursor: pointer;
    border: 1px solid transparent;
    text-decoration: none;
  }
  button { background: #111827; color: #fff; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-secondary { background: #fff; color: #111827; border-color: #d1d5db; }
  .btn-secondary:hover { border-color: #9ca3af; }

  .hint { color: #6b7280; font-size: 13px; margin-top: 8px; }
  .section-title { margin: 0 0 8px 0; }

  .toolbar {
    margin-top: 12px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: flex-end;
  }
  .toolbar .grow { flex: 1; min-width: 220px; }

  .actions { display: flex; gap: 10px; flex-wrap: wrap; }
  .actions .btn { min-width: 140px; }

  .prominent-footer { margin-top: 14px; }
  .prominent-footer .btn { width: 100%; }

  /* Results cards */
  .results { margin-top: 16px; }
  .bundle-card {
    border: 1px solid #e6e6e6;
    border-left: 4px solid #2563eb;
    border-radius: 14px;
    background: #fff;
    padding: 14px;
    margin-top: 12px;
  }
  .bundle-head {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
  }
  .bundle-title { font-size: 18px; font-weight: 900; margin: 0; }
  .bundle-sub { margin-top: 4px; color: #6b7280; font-size: 13px; }
  .bundle-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .bundle-actions button { background: #fff; color: #111827; border: 1px solid #d1d5db; }
  .bundle-actions button:hover { border-color: #9ca3af; }

  .video-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 10px 0;
    border-top: 1px solid #f1f5f9;
  }
  .video-left { display: flex; align-items: center; gap: 10px; }
  .video-icon {
    width: 30px; height: 30px;
    border-radius: 8px;
    background: #eff6ff;
    display: flex; align-items: center; justify-content: center;
    color: #2563eb;
    font-weight: 900;
  }
  .video-title { font-weight: 800; }
  .video-actions button { background: #fff; color: #111827; border: 1px solid #d1d5db; }
  .video-actions button:hover { border-color: #9ca3af; }
</style>
{% endblock %}

{% block content %}
<div class="card">
  <h3 class="section-title">Doctor</h3>

  <div class="profile-row">
    <div class="avatar" aria-label="Doctor photo">
      <div style="line-height:1;">{{ doctor.user.full_name|default:"D"|slice:":1"|upper }}</div>
      {% if doctor.photo %}
        <img class="avatar-img" src="{{ doctor.photo.url }}" alt="Doctor photo" loading="lazy" onerror="this.remove();" />
      {% endif %}
    </div>
    <div>
      <div style="font-size: 18px; font-weight: 800;">Dr. {{ doctor.user.full_name }}</div>
      <div class="muted">{{ doctor.clinic.display_name }}</div>
      <div class="muted">Doctor ID: {{ doctor.doctor_id }}</div>
    </div>
  </div>

  <div class="row two" style="margin-top: 12px;">
    <div>
      <div class="kv"><b>Doctor WhatsApp</b> {{ doctor.whatsapp_number }}</div>
      <div class="kv"><b>IMC / Reg.</b> {{ doctor.imc_number }}</div>
    </div>
    <div>
      <div class="kv"><b>Clinic phone</b> {{ doctor.clinic.clinic_phone }}</div>
      {% if doctor.clinic.clinic_whatsapp_number %}
        <div class="kv"><b>Clinic WhatsApp</b> {{ doctor.clinic.clinic_whatsapp_number }}</div>
      {% endif %}
    </div>
  </div>

  <div class="muted" style="margin-top: 10px;">
    {{ doctor.clinic.address_text|linebreaksbr }}<br>
    {{ doctor.clinic.state }}{% if doctor.clinic.postal_code %} — {{ doctor.clinic.postal_code }}{% endif %}
  </div>
</div>

<div class="card">
  <h3 class="section-title">Share Patient Education</h3>

  <div class="row three" style="margin-top: 6px;">
    <div>
      <label for="therapySel">Therapy Area</label>
      <select id="therapySel"></select>
    </div>

    <div>
      <label for="triggerSel">Trigger</label>
      <select id="triggerSel"></select>
    </div>

    <div>
      <label for="bundleSel">Bundle</label>
      <select id="bundleSel"></select>
    </div>
  </div>

  <div class="toolbar">
    <div class="grow">
      <label for="searchBox">Search Bundles / Videos</label>
      <input id="searchBox" type="text" placeholder="Type keywords…" autocomplete="off" />
    </div>

    <div style="min-width: 220px;">
      <label for="lang">Language</label>
      <select id="lang">
        {% for code, name in languages %}
          <option value="{{ code }}">{{ name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div id="contextHint" class="hint"></div>

  <!-- RESULTS (bundle cards) -->
  <div id="results" class="results"></div>

  <div class="toolbar">
    <div class="grow">
      <label for="waNumber">Patient WhatsApp number</label>
      <input id="waNumber" type="tel" maxlength="10" placeholder="10-digit number" inputmode="numeric" />
      <div class="hint">Enter the patient's 10-digit WhatsApp number (India).</div>
    </div>

    <div class="actions">
      <button class="btn" id="shareVideoBtn" style="display:none;">Share Video</button>
      <button class="btn" id="shareBundleBtn" style="display:none;">Share Bundle</button>
    </div>
  </div>

  <div class="prominent-footer">
    <a class="btn btn-secondary" href="{% url 'accounts:modify_clinic_details' doctor_id=doctor.doctor_id %}">
      Modify Clinic Details
    </a>
  </div>
</div>

{{ catalog_json|json_script:"catalog-json" }}

<script>
const catalog = JSON.parse(document.getElementById("catalog-json").textContent);

const therapySel = document.getElementById("therapySel");
const triggerSel = document.getElementById("triggerSel");
const bundleSel = document.getElementById("bundleSel");
const searchBox = document.getElementById("searchBox");
const langSel = document.getElementById("lang");

const resultsDiv = document.getElementById("results");
const contextHint = document.getElementById("contextHint");

const waNumber = document.getElementById("waNumber");
const shareVideoBtn = document.getElementById("shareVideoBtn");
const shareBundleBtn = document.getElementById("shareBundleBtn");

let activeBundleCode = "";
let activeVideo = null;

// -------------------- helpers --------------------
function validWA() {
  return /^\d{10}$/.test((waNumber.value || "").trim());
}

function escapeHtml(str) {
  return String(str || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

const therapyByCode = {};
(catalog.therapy_areas || []).forEach(t => therapyByCode[t.code] = t.display_name || t.code);

const triggerByCode = {};
(catalog.triggers || []).forEach(tr => triggerByCode[tr.code] = tr);

const bundleByCode = {};
(catalog.bundles || []).forEach(b => bundleByCode[b.code] = b);

function bundleLabel(b, lang) {
  if (!b) return "";
  const names = b.names || {};
  return (names[lang] || names["en"] || b.display_name || b.code || "").trim();
}

function populateSelect(el, items, labelFn, includeAll=true) {
  el.innerHTML = "";
  if (includeAll) {
    const allOpt = document.createElement("option");
    allOpt.value = "";
    allOpt.textContent = "-- All --";
    el.appendChild(allOpt);
  }
  (items || []).forEach(i => {
    const o = document.createElement("option");
    o.value = i.code;
    o.textContent = (labelFn(i) || i.code || "").trim();
    el.appendChild(o);
  });
}

// Sort alphabetically
function alphaSortByLabel(items, getLabel) {
  return (items || []).slice().sort((a,b) => {
    const A = (getLabel(a) || "").toLowerCase();
    const B = (getLabel(b) || "").toLowerCase();
    return A.localeCompare(B);
  });
}

// Build trigger dropdown from therapy selection
function triggersForTherapy(therapyCode) {
  const all = (catalog.triggers || []);
  if (!therapyCode) return all;
  return all.filter(t => (t.therapy_code || "") === therapyCode);
}

// Build bundle dropdown from therapy + trigger
function bundlesForTherapyTrigger(therapyCode, triggerCode) {
  const all = (catalog.bundles || []);
  return all.filter(b => {
    if (therapyCode && (b.therapy_code || "") !== therapyCode) return false;
    if (triggerCode && (b.trigger_code || "") !== triggerCode) return false;
    return true;
  });
}

// Videos within a bundle
function videosForBundle(bundleCode) {
  const vids = (catalog.videos || []).filter(v => Array.isArray(v.bundle_codes) && v.bundle_codes.includes(bundleCode));
  return vids;
}

function videoTitle(v, lang) {
  return (v.titles && (v.titles[lang] || v.titles["en"])) || v.id;
}

// Search matching: bundle name OR video search_text
function bundleMatchesQuery(bundleCode, q, lang) {
  if (!q) return true;
  const b = bundleByCode[bundleCode];
  const name = (bundleLabel(b, lang) || "").toLowerCase();
  const code = (bundleCode || "").toLowerCase();
  return name.includes(q) || code.includes(q);
}

function videoMatchesQuery(v, q) {
  if (!q) return true;
  return ((v.search_text || "").toLowerCase().includes(q));
}

function setActiveBundle(bundleCode) {
  activeBundleCode = bundleCode || "";
  activeVideo = null;
  // Also set dropdown value
  if (bundleCode) bundleSel.value = bundleCode;
  updateButtons();
  renderResults();
}

function setActiveVideo(bundleCode, v) {
  activeBundleCode = bundleCode || "";
  activeVideo = v || null;
  if (bundleCode) bundleSel.value = bundleCode;
  updateButtons();
  renderResults();
}

// Message builder
function buildMessage(title, link, lang) {
  const prefix = (catalog.message_prefixes && catalog.message_prefixes[lang]) || "";
  const p = (prefix || "").trim();
  const t = (title || "").trim();
  let msg = "";
  if (p) msg += p + "\n\n";
  if (t) msg += t + "\n";
  msg += link;
  return msg;
}

function shareToWhatsApp(message) {
  const num = (waNumber.value || "").trim();
  if (!/^\d{10}$/.test(num)) return;
  window.open(`https://wa.me/91${num}?text=${encodeURIComponent(message)}`);
}

// Buttons at bottom
function updateButtons() {
  const waOk = validWA();

  if (activeVideo) {
    shareVideoBtn.style.display = "inline-block";
    shareBundleBtn.style.display = "none";
    shareVideoBtn.disabled = !waOk;
    contextHint.textContent = `Selected video: ${videoTitle(activeVideo, langSel.value)}`;
    return;
  }

  if (activeBundleCode) {
    shareVideoBtn.style.display = "none";
    shareBundleBtn.style.display = "inline-block";
    shareBundleBtn.disabled = !waOk;
    const bName = bundleLabel(bundleByCode[activeBundleCode], langSel.value) || activeBundleCode;
    contextHint.textContent = `Bundle selected: ${bName}`;
    return;
  }

  shareVideoBtn.style.display = "none";
  shareBundleBtn.style.display = "none";
  contextHint.textContent = "";
}

// Render bundle cards (works for search AND dropdown selections)
function renderResults() {
  const lang = langSel.value;
  const q = (searchBox.value || "").toLowerCase().trim();
  const therapy = (therapySel.value || "").trim();
  const trigger = (triggerSel.value || "").trim();
  const bundle = (bundleSel.value || "").trim();

  // Determine which bundles to show:
  // - If bundle selected: show that one
  // - Else if therapy/trigger selected: show matching bundles
  // - Else if search query: show bundles that match query OR contain matching videos
  // - Else: show nothing (avoid dumping all)
  let bundleCodes = [];

  if (bundle) {
    bundleCodes = [bundle];
  } else if (therapy || trigger) {
    bundleCodes = bundlesForTherapyTrigger(therapy, trigger).map(b => b.code);
  } else if (q) {
    bundleCodes = (catalog.bundles || [])
      .filter(b => {
        if (bundleMatchesQuery(b.code, q, lang)) return true;
        // otherwise check if any video in bundle matches
        const vids = videosForBundle(b.code);
        return vids.some(v => videoMatchesQuery(v, q));
      })
      .map(b => b.code);
  } else {
    resultsDiv.innerHTML = "";
    return;
  }

  // alpha sort by bundle label
  bundleCodes = bundleCodes
    .slice()
    .sort((a,b) => (bundleLabel(bundleByCode[a], lang) || a).toLowerCase().localeCompare((bundleLabel(bundleByCode[b], lang) || b).toLowerCase()));

  if (!bundleCodes.length) {
    resultsDiv.innerHTML = `<div class="hint">No matching bundles/videos.</div>`;
    return;
  }

  const html = [];
  bundleCodes.forEach(bc => {
    const b = bundleByCode[bc];
    if (!b) return;

    const bName = bundleLabel(b, lang) || bc;

    // Videos to show:
    // - If searching: show only matching videos; if bundle name matches, show all
    // - Else: show all bundle videos
    let vids = videosForBundle(bc);
    vids = vids.slice().sort((x,y) => videoTitle(x, lang).toLowerCase().localeCompare(videoTitle(y, lang).toLowerCase()));

    if (q) {
      const bundleNameMatched = bundleMatchesQuery(bc, q, lang);
      if (!bundleNameMatched) {
        vids = vids.filter(v => videoMatchesQuery(v, q));
      }
    }

    const therapyName = b.therapy_code ? (therapyByCode[b.therapy_code] || b.therapy_code) : "";
    const triggerName = b.trigger_code ? ((triggerByCode[b.trigger_code] && triggerByCode[b.trigger_code].display_name) || b.trigger_code) : "";

    html.push(`
      <div class="bundle-card" data-bundle="${escapeHtml(bc)}">
        <div class="bundle-head">
          <div>
            <div class="bundle-title">${escapeHtml(bName)}</div>
            <div class="bundle-sub">
              ${triggerName ? `Trigger: ${escapeHtml(triggerName)}` : ""}
              ${triggerName && therapyName ? " · " : ""}
              ${therapyName ? `Therapy: ${escapeHtml(therapyName)}` : ""}
              ${therapyName || triggerName ? " · " : ""}
              ${vids.length} video(s)
            </div>
          </div>
          <div class="bundle-actions">
            <button type="button" data-action="select-bundle" data-bundle="${escapeHtml(bc)}">Select bundle</button>
          </div>
        </div>

        ${vids.map(v => {
          const vt = videoTitle(v, lang);
          const isSel = (activeVideo && activeVideo.id === v.id);
          return `
            <div class="video-row">
              <div class="video-left">
                <div class="video-icon">▶</div>
                <div class="video-title">${escapeHtml(vt)}</div>
              </div>
              <div class="video-actions">
                <button type="button"
                        data-action="select-video"
                        data-bundle="${escapeHtml(bc)}"
                        data-video="${escapeHtml(v.id)}">
                  Select video
                </button>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `);
  });

  resultsDiv.innerHTML = html.join("");

  // Attach click handlers (delegation)
  resultsDiv.querySelectorAll("button[data-action='select-bundle']").forEach(btn => {
    btn.addEventListener("click", () => {
      const bc = btn.getAttribute("data-bundle") || "";
      setActiveBundle(bc);
    });
  });

  resultsDiv.querySelectorAll("button[data-action='select-video']").forEach(btn => {
    btn.addEventListener("click", () => {
      const bc = btn.getAttribute("data-bundle") || "";
      const vid = btn.getAttribute("data-video") || "";
      const v = (catalog.videos || []).find(x => x.id === vid);
      if (v) setActiveVideo(bc, v);
    });
  });
}

// -------------------- initial population --------------------
const therapiesSorted = alphaSortByLabel(catalog.therapy_areas || [], t => t.display_name || t.code);
populateSelect(therapySel, therapiesSorted, t => t.display_name || t.code);

function repopulateTriggers() {
  const therapy = (therapySel.value || "").trim();
  const triggers = triggersForTherapy(therapy);
  const sorted = alphaSortByLabel(triggers, t => t.display_name || t.code);
  populateSelect(triggerSel, sorted, t => t.display_name || t.code);
}

function repopulateBundles() {
  const therapy = (therapySel.value || "").trim();
  const trigger = (triggerSel.value || "").trim();
  const bundles = bundlesForTherapyTrigger(therapy, trigger);
  const sorted = alphaSortByLabel(bundles, b => bundleLabel(b, langSel.value) || b.code);
  populateSelect(bundleSel, sorted, b => bundleLabel(b, langSel.value) || b.code);
}

repopulateTriggers();
repopulateBundles();
updateButtons();
renderResults();

// -------------------- dropdown behavior --------------------
therapySel.addEventListener("change", () => {
  // therapy change: refresh triggers + bundles, clear active selection
  activeBundleCode = "";
  activeVideo = null;
  repopulateTriggers();
  repopulateBundles();
  updateButtons();
  renderResults();
});

triggerSel.addEventListener("change", () => {
  activeBundleCode = "";
  activeVideo = null;
  repopulateBundles();
  updateButtons();
  renderResults();
});

bundleSel.addEventListener("change", () => {
  const bc = (bundleSel.value || "").trim();
  if (bc) {
    // Selecting bundle from dropdown should render the same bundle card UI
    setActiveBundle(bc);
  } else {
    activeBundleCode = "";
    activeVideo = null;
    updateButtons();
    renderResults();
  }
});

langSel.addEventListener("change", () => {
  // language affects labels and titles
  repopulateBundles();
  updateButtons();
  renderResults();
});

searchBox.addEventListener("input", () => {
  // do not forcibly clear bundle selection; search should still show results
  renderResults();
});

waNumber.addEventListener("input", updateButtons);

// -------------------- Share buttons (bottom) --------------------
shareVideoBtn.onclick = () => {
  if (!activeVideo) return;
  const lang = langSel.value;
  const title = videoTitle(activeVideo, lang);
  const link = `${location.origin}/p/${catalog.doctor_id}/v/${activeVideo.id}/?lang=${lang}`;
  shareToWhatsApp(buildMessage(title, link, lang));
};

shareBundleBtn.onclick = () => {
  const bc = activeBundleCode || (bundleSel.value || "").trim();
  if (!bc) return;
  const lang = langSel.value;
  const title = bundleLabel(bundleByCode[bc], lang) || bc;
  const link = `${location.origin}/p/${catalog.doctor_id}/c/${bc}/?lang=${lang}`;
  shareToWhatsApp(buildMessage(title, link, lang));
};
</script>
{% endblock %}
